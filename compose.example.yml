x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '50m'
    max-file: 6

x-base: &base
  profiles: [fillakit]
  build:
    context: .
    dockerfile: Dockerfile
    args:
      APP_ENV: '${APP_ENV:-production}'
      WWWUSER: ${HOST_UID:-1000}
      WWWGROUP: ${HOST_GID:-1000}
      TZ: ${APP_TIMEZONE:-America/New_York}
  image: ${DOCKER_IMAGE:-akrista/fillakit:latest}
  user: '${HOST_UID:-1000}:${HOST_GID:-1000}'
  ulimits:
    nofile:
      soft: 20000
      hard: 40000
  security_opt:
    - no-new-privileges:true
  networks:
    - stack
  volumes:
    - './storage/app/public:/var/www/html/storage/app/public'
    - './storage/logs:/var/www/html/storage/logs'
    - './storage/sqlite:/var/www/html/storage/sqlite'
  env_file:
    - .env
  logging: *default-logging
  restart: unless-stopped

# === Network Configuration ===
networks:
  stack:
    driver: bridge

services:
  fillakit:
    <<: *base
    container_name: fillakit
    env_file:
      - .env
    healthcheck:
      test: ['CMD', 'curl', '--fail', 'localhost:8000/up']
      interval: 3s
      retries: 12
      timeout: 5s
    ports:
      - '${APP_PORT:-8000}:${APP_PORT:-8000}'
